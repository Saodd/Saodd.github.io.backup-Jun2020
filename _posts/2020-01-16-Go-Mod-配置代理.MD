---
layout: post
title:  "为 Go Mod 配置代理"
date:   2020-01-16
tags: Golang
color: rgb(255,0,0)
---

> 终于开始了基于Golang的开发工作。然而换了一个环境发现，Go Mod 对国内环境的支持及其不友好，折腾半天终于算是处理好了。

## 问题

在使用`go mod`命令时出现了各种问题，比如：

1. 下载不了github开源模块（因为连不上`Checksum Database`）：

```shell-session
$ go mod tidy
go: downloading github.com/pkg/errors v0.9.1
verifying github.com/pkg/errors@v0.9.1: github.com/pkg/errors@v0.9.1: Get https://sum.golang.org/lookup/github.com/pkg/errors@v0.9.1: dial tcp 216.58.200.49:443: connectex: A connection attempt failed because the connected party did not properly respond af
ter a period of time, or established connection failed because connected host has failed to respond.
```

2. 下载不了`golang.org/x/`包：

```shell-session
$ go get -u github.com/gin-gonic/gin
package golang.org/x/sys: unrecognized import path "golang.org/x/sys/" (... connect: connection refused)
```

总之，问题就在于连不上谷歌的在线服务，不能下载、不能验证，问题多多。就算配置了相关的出国代理，在浏览器可用，但是在golang中还是不可用。

3. 自己写的golang程序也不能自动使用代理。

## 解决Go Mod 问题

看了很多资料，最后真正解决问题的是这一篇：[干货满满的 Go Modules 和 goproxy.cn - 煎鱼eddycjy](https://juejin.im/post/5d8ee2db6fb9a04e0b0d9c8b)，感谢，侵删。

关键在于设置`GOPROXY`环境变量。对于这个，在此特别感谢七牛赞助的[goproxy.cn](https://github.com/goproxy/goproxy.cn/blob/master/README.md)项目，我们只要把代理指向`goproxy.cn`就可以解决问题了。

### 办法一：终端上设置临时变量

通过go命令设置。但是会提示你，它不会覆盖OS的变量，因此无效。

```shell-session
PS C:\Users\Lewin> go env -w GOPROXY=https://goproxy.cn,direct
warning: go env -w GOPROXY=... does not override conflicting OS environment variable
```

然后Linux和Windows分别可以用(注意这样设置都是临时的)：

```shell
$ export GOPROXY=https://goproxy.cn

$env:GOPROXY = "https://goproxy.cn"
```

### 办法二：windows永久变量（推荐）

在 我的电脑-高级系统设置-环境变量 中新建一个变量。这样设置后全局永久有效。

### 办法三：Goland中为项目单独配置

在 File - Settings - Go Modules(vgo) 中，在`Proxy`一栏输入`https://goproxy.cn,direct`

## 解决Go 代码问题

因公司业务需要访问一些资源，所以在程序中使用`http.Client`访问资源时，会提示`TLS handshake timeout`之类的错误信息。

解决办法是给`http.Client`设置代理（具体的代理地址看你本地的设定，一般默认是1080端口）：

```go
func GetHttpClient() *http.Client {
	proxy := func(_ *http.Request) (*url.URL, error) {
		return url.Parse("http://localhost:1080")
	}

	tr := &http.Transport{
		Proxy: proxy,
	}

	c := &http.Client{
		Transport: tr,
		Timeout:   1 * time.Second,
	}

	return c
}
```

然后使用这个`Client`去访问资源就可以了。

底层机制暂时不清楚。如果以后了解到了再更新吧。
