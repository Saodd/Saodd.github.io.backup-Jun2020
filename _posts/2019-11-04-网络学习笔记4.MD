---
layout: post
title:  "网络学习笔记4：网络层"
date:   2019-10-15
tags: 网络
color: rgb(255,102,51)
---

> 第三层，网络层。主要是IP协议。

# 第四章 Network Layer

 网络层在每个终端和路由器中都在运行着，因此它是最复杂也是最有趣的一层。
 
 在这一章里，我们首先要区分『转发`forwarding`』和『路由`routing`』：转发是在单个路由器中从输入端移到输出端的过程，而路由指的是所有路由器工作的集合。
 
为了深入理解转发，我们会看看路由器的内部构造。然后学习IP、NAT、IPv4、ICMP、IPv6等概念。为了理解路由，我们会学习路由算法。

## 4.1 介绍

### 4.1.1 转发和路由

在现实中『转发』和『路由』经常被混淆使用，在本书中会精确地区分。

每个路由器都有『转发表`forwarding table`』。从输入包中读取头部某个字段，然后在表中查找知道从哪个口输出。表大概长这样：

|  header value  |  output link  |
| :---: | :---:|
| 0100 | 3 |
| 0101 | 2 |
| 0111 | 2 |
| 1001 | 1 |

还有一些术语要说明一下。我们接下来说『包交换`packet switch`』指的是一种通用的、根据包头字段从输入端转发到输出端的交换设备。有连接层交换机和路由器这两种。

除了转发和路由之外，网络层还有一个重要功能是『连接准备`connection setip`』，就像TCP的三次握手一样，有些网络层架构要求提前准备好连接状态。

### 4.1.2 网络服务模型

提供的服务其实跟TCP当时分析的差不多，就是那些。因特网架构提供的服务模型是『尽力Best Effort』，不保证带宽、丢包、顺序、延迟、拥塞控制。还有一种架构称为`ATM`，可能提供可靠传输服务。

## 4.2 虚拟电路和数据报网络

网络层与传输层类似的，也分为面向连接的和无连接的服务两种。看起来是重复了，但是我们注意一些关键不同：

- 网络层提供的是主机到主机的服务，而传输层是进程到进程的；
- 有连接的称为『虚拟电路网络`virtual-circuit(VC) network`』，无连接的称为『报文段网络`datagram networks`』。
- 面向连接服务的实现完全不同。传输层是在终端上进行控制，而网络层是在网络核心（路由器）上实现的。

### 4.2.1 虚拟电路网络

一个VC包含：①一条从始发地到目的地的『路径`path`』，由沿途的link和routers组成；②『VC号码』，沿着路径上每个link都有一个号码；③存在路径上的路由器中的转发表中的记录。

每个数据包都会在header中包含一个VC号码，而由于每个link可能是不同的号码，因此每次转发时都要更换header中的VC号码。

转发表大概长这样：

|  Incoming Interface  |  Incoming VC #  |  Outgoing Interface  |  Outgoing VC #  |
| :---: | :---:| :---: | :---:|
| 1 | 12 | 2 | 22 |
| 2 | 63 | 1 | 18 |
| 3 | 97 | 2 | 17 |
| 1 | 7 | 3 | 87 |

为什么每次转发都要更换号码？第一减少头部的号码字段长度，第二每个路由器可以随意独立地选择号码而无需跟其他路由器确认。

VC的生命周期有三个阶段：

- VC设置：终端网络层负责决定路径，在这个过程中会在路径上每个路由器设置VC号码。
- 数据传输
- VC关闭：反向操作，即通知路径上的路由释放掉相关的号码。

记住，传输层只是在两个终端上建立连接变量；而网络层是在整个沿途的所有路由上建立。

（未完待续）